# Bunner Shield RS 라이브러리 검토 보고서
# Bunner Shield RS 개선 작업 목록 (핵심 보안 방어 중심, 중복 제거)

본 문서는 HTTP 보안 방어에 직접 기여하는 “작업 필요 항목”만을 기능별로 재그룹핑해 정리했습니다. 보고/Report 계열과 deprecated 사안은 제외했습니다.

## 공통/인프라

- NormalizedHeaders 다중값 지원 재설계
  - 반환 타입을 다중값을 안전히 표현(예: HashMap<String, Vec<String>> 또는 전용 타입)하도록 교체하여 개행 결합 제거
  - 프레임워크별 어댑터(Actix/Axum/Warp 등)에서 반복 헤더를 자연스럽게 방출할 수 있는 어댑터 계층 제공
- 다중값 처리 정책 명시화
  - 허용 헤더 화이트리스트/블랙리스트 정책 정의 및 확장 가능 API 제공
- CRLF(헤더 인젝션) 전역 방어
  - 옵션/빌더/실행기/정규화 경로 전반에서 CR/LF 포함 시 거부하는 공통 유틸 적용
- Set-Cookie 파이프라인 경계 강화
  - 입력에 개행/접두("Set-Cookie:") 혼입 시 명시 거부, 정규화 경로만 다중값 관리

## CSP (Content-Security-Policy)

- require-trusted-types-for 지원
  - 안전한 Trusted Types 도입을 위한 Builder/API 추가
- 지시어 최신화 자동 점검
  - 지시어 목록·동작의 표준 변경 추적을 테스트/검증으로 자동화(예: strict-dynamic 등)
- 런타임 nonce 경로 안정화
  - runtime_nonce_config 사용부의 expect 제거, 명시적 에러 반환으로 패닉 가능성 제거
- 옵션 구조 정리/문서화
  - options/ 하위 모듈을 역할군(검증/빌더/구성)으로 재그룹핑하고, 각 모듈 책임을 문서화

## HSTS (Strict-Transport-Security)

- 해제 경로 허용
  - RFC에 맞게 max-age=0 허용 또는 전용 비활성 옵션 제공(검증 로직 수정)

## Permissions-Policy

- 입력 검증 강화
  - 기능명·토큰 유효성 강화(제어문자/공백/인젝션 거부), 브라우저 권한 레지스트리 기반의 소프트 검증/경고 추가
- CRLF 방어 일원화
  - 정책 문자열 조립 전 공통 검증 유틸 사용

## CSRF

- 키 보호·로테이션
  - 비밀 키 메모리 zeroize, 검증키 윈도우 만료/교체 도우미 제공
- 만료/재사용 방지 통합 경로
  - verify_with_max_age/verify_and_consume를 실행 파이프라인에서 선택적으로 활용할 보조 Executor 또는 헬퍼 제공

## DX/아키텍처

- 실행기 추상화 보강
  - 다중 헤더 전용 보일러플레이트를 줄이는 보조 매크로 추가, 필요한 경우 트레이트 공개 범위 재검토
- Shield 빌더 패턴
  - 일관된 체이닝 구성을 위한 Shield::builder() 제공(강제/옵션 기능 포함 설계)
- 모듈 패턴 정합성
  - x_powered_by를 포함해 모듈 전반을 *Options/*Executor 패턴으로 통일
- Cargo feature 게이팅
  - 모듈 단위 feature 플래그로 바이너리 크기/빌드 시간 제어
- 문자열 소유·차용 일관성
  - Cow<'static, str> 사용 기준 통일(정적 리터럴 Borrowed, 런타임 조립 Owned), 불필요한 복제 제거

## 오류 모델

- 에러 생태계 정합성 강화
  - 모든 *OptionsError/*ExecutorError -> ShieldError 변환 계층(From) 보강
  - 기계 친화적 에러 코드 + 사람 친화적 메시지 규약 정립

## 테스트/자동화

- 다중값 헤더 방출 검증
  - 전송 계층에서 반복 헤더로 올바르게 분리 방출되는지 통합 테스트 추가(특히 Set-Cookie)
- CRLF 거부 규칙 회귀 테스트
  - 옵션/빌더/정규화/실행기 전 경로에 대한 인젝션 방어 테스트 포함
- 표준 동기화 가드
  - CSP 지시어·권한 레지스트리 등 표준 변경 추적을 테스트 기반으로 주기 검증
- Panic 불가 계약 확인: 런타임 nonce 경로에서 `expect` 사용은 상태상 불가능한 분기지만, 방어적 코드로 전환(옵션 부재 시 명시 에러 반환)하여 하위 호환을 유지하면서 런타임 패닉 가능성을 제거하세요.
  - **타당성 검토:** `src/csp/executor.rs`에서 `runtime_nonce_config().expect(...)`가 사용되어 런타임 설정 누락 시 패닉이 발생할 수 있습니다.

## 4) DX 일관성

- 다중값 헤더 안전 API: 반환 타입을 다중값을 표현 가능한 구조로 교체하고, 프레임워크별 어댑터(예: actix/axum/warp 등)에서 자연스럽게 반복 헤더를 방출하도록 어댑터 계층을 추가하세요.
  - **타당성 검토:** 현재 `Shield::secure`가 `HashMap<String, String>`을 반환해 헤더 중복 표현이 불가능하며, 프레임워크별 어댑터가 제공되지 않습니다.
 
- 에러 생태계 정합성: 모든 `*OptionsError`/`*ExecutorError`를 `ShieldError`로 자동 변환하는 `From` 계층을 전부 갖추고, 에러 메시지/코드 규약(기계 친화적 코드 + 사람 친화적 메시지)을 통일하세요.
  - **타당성 검토:** 현재 `ShieldError`는 wrap만 제공하고 에러 코드, 문맥 정보가 부족해 사용자 친화적 처리가 어렵습니다.
- 테스트 규약 확장: 다중값 헤더 출력의 전송 계층 호환성(헤더 분리 방출)을 보장하는 통합 테스트를 추가하고, CRLF 거부 규칙에 대한 회귀 테스트를 포함하세요.
  - **타당성 검토:** 현 테스트는 주로 단일 헤더 값 검증에 집중되어 있으며, 다중값 및 인젝션 방어에 대한 통합 테스트가 부재합니다.
