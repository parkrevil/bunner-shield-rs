## 1) 부족하거나 빠진 기능 혹은 옵션

 - CSP
  - `report-to` 병합 전략 고정: 다중 옵션 병합 시 “최초 그룹 유지”만 허용됩니다. 서비스에 따라 최종값 우선/합집합 등 전략 선택이 필요할 수 있으나 현재 옵션이 없습니다.
  - 세부 스킴 허용/금지 토글 부재: 구현에 지시자별 스킴 제한이 있으나, 이미지/미디어에서의 data: 허용 등 브라우저별 허용 차이를 정책적으로 선택(허용/차단)하는 토글은 제공하지 않습니다.

- Permissions-Policy
  - 값 모델이 단일 문자열: 피처별 allowlist((), 'self', https://origin 등)를 타입 안전하게 구성/검증하는 API가 없습니다. 공백/중복/형식 오류에 대한 구조적 검증이 제한적입니다.

- CSRF
  - 키 회전(다중 서명 키) 미지원: 운영 중 키 교체를 위한 동시에 유효한 복수 키 검증 체계가 내장되어 있지 않습니다.
  - 재생 방지 저장소 추상화 제한: 내부 스토어 인터페이스가 백엔드 교체(예: 분산 캐시, TTL 보장) 관점에서 추상화 수준이 더 높을 필요가 있습니다.

 

## 2) 리팩토링 필요한 부분

- Executor 보일러플레이트 최소화
  - 여러 executor가 `CachedHeader`를 동일 패턴으로 감싸고 `execute`에서 헤더 삽입만 수행합니다. 공통 매크로/헬퍼로 생성자(new)와 `execute` 구현을 더 단순화해 중복을 줄일 수 있습니다(동적 값 분기(CSP 런타임 nonce)만 특수화).

- CSP 옵션 머지/출력 경로의 문자열 할당 감소
  - `header_value` 조합, `merge` 시 토큰 단위 추가 등에서 다수의 임시 할당이 발생할 수 있습니다. 토큰 수 기반의 사전 용량 예약, 스트림 조합기로의 일원화로 할당을 줄일 수 있습니다.

- 검증 모듈 테스트 노출 경로 단순화
  - `#[cfg(test)]` 재노출로 내부 함수에 접근합니다. 테스트 전용 유틸 모듈로 집약하거나, 내부 가시성 조정으로 재노출 폭을 줄이면 모듈 경계가 더 명확해집니다.

- 빌더 API 표면 일관화
  - CSP에는 `add_source`와 빌더 체인이 공존합니다. 하나의 경로(빌더) 중심으로 가이드하고, `add_source`는 내부 전용 도우미로 축소하면 표면 API가 더 일관됩니다.

- SameSite/Set-Cookie 처리 경로의 파싱/정규화 유틸 공유화
  - 속성 분리/정규화 로직이 여러 테스트 케이스를 통해 검증되나, 유틸 단으로 더 모듈화하면 가독성과 재사용성이 개선됩니다.

## 3) 보강 및 개선이 필요한 부분

- CSP
  - `report-to` 병합 전략 선택권: 첫 그룹 유지/최종값 우선/합집합(중복 제거) 등 전략을 옵션화.
  - 스킴 위험도 경고 고도화: 지시자별 허용 가능한 스킴 목록을 더 세분화해 브라우저 관행 기반의 정보/경고 레벨을 풍부화(예: 이미지 data: 허용 시 경고, 스크립트 data: 차단 등).
  - 대규모 정책 조합 성능: 토큰 병합/중복 제거 경로에서 `SmallVec`/reserve 등으로 할당/복사를 최소화.

- Permissions-Policy
  - 타입 안전 빌더/검증: 피처 이름/allowlist 값에 대한 최소 파싱과 정규화(공백 트림, 중복 제거), 허용되지 않는 형식 조기 거부.
  - 정책 합성 규칙 명시화: 다중 피처 설정 시 마지막 값 우선/병합 선택권 제공.

- CSRF
  - 키 회전 지원: 다중 키 검증(현재 키+이전 키)과 점진적 폐기 모델.
  - 스토어 추상화 강화: 재생 방지 저장의 TTL/동시성/분산 백엔드 교체 용이성을 위한 트레이트 세분화.
  - 에러 경계 강화: 인코딩/길이 초과/지원하지 않는 버전 등에 대한 상한선 및 메시지 일관성 추가.

- SameSite
  - 초장문 Cookie 헤더 처리 최적화: 매우 큰 헤더 세트 입력 시 파싱/정규화 경로의 할당/복사 최소화.

- 전반
  - Executor 유틸리티화: 헤더 삽입/캐시 재사용 공통 구현을 헬퍼/매크로로 제공하여 중복 제거 및 신기능 반영 속도 향상.
  - 경고 레벨 확장: 현재 Info/Warning/Critical 체계를 활용해 호환성 관련 권고(Informational) 범주를 확대하여 운영 판단에 도움 제공.
